<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 必备设置 -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="奇門解盤">

    <!-- 图标（放在 assets 文件夹中） -->
    <link rel="apple-touch-icon" href="assets/icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3544992444238506"
     crossorigin="anonymous"></script>
    
    <title data-i18n="page_title">奇門解盤</title>
    <style>
        body {
            background: #fafafa;
            font-family: 'HarmonyOS Sans', 'Noto Sans SC', 'Noto Sans TC', 'Microsoft YaHei', '微软雅黑', 'Arial', sans-serif;
            color: #222;
            margin: 0;
            min-height: 100vh;
        }
        .main-container {
            max-width: 800px;
            margin: 40px auto 0 auto;
            padding: 0 16px;
        }
        .title {
            text-align: center;
            font-size: 2.6rem;
            font-weight: bold;
            letter-spacing: 4px;
            margin-top: 32px;
            margin-bottom: 12px;
            font-family: 'HarmonyOS Sans', 'Noto Sans SC', 'Noto Sans TC', 'Microsoft YaHei', '微软雅黑', 'Arial', sans-serif;
        }
        .divider {
            border: none;
            border-top: 2px solid #222;
            width: 60%;
            margin: 18px auto 24px auto;
            opacity: 0.12;
        }
        .form-group {
            margin-bottom: 22px;
        }
        .form-label {
            display: block;
            font-size: 1.08rem;
            color: #444;
            margin-bottom: 7px;
            font-weight: 500;
            letter-spacing: 1px;
        }
        .hint-inline {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            margin-left: 6px;
        }
        .input-box,
        .form-select {
            display: block;
            width: 100%;
            max-width: 500px;               /* ✅ 限制最大宽度，防止iPad上过宽 */
            font-size: 1.1rem;
            padding: 12px 14px;
            border: 1.5px solid #222;
            border-radius: 12px;
            background: #fff;
            box-sizing: border-box;         /* ✅ padding不撑大外部宽度 */
            outline: none;
            transition: border 0.2s;
            font-family: 'HarmonyOS Sans', 'Noto Sans SC', 'Noto Sans TC', 'Microsoft YaHei', '微软雅黑', 'Arial', sans-serif;
            -webkit-appearance: none;       /* ✅ iOS设备清除系统样式差异 */
            appearance: none;
            margin: 0 auto;                 /* ✅ 在大屏上居中展示 */
        }
        .input-box:focus, .form-select:focus {
            border: 1.5px solid #555;
        }
        .main-btn {
            display: block;
            width: 100%;
            background: #111;
            color: #fff;
            font-size: 1.3rem;
            font-weight: bold;
            border: none;
            border-radius: 24px;
            padding: 12px 0;
            margin: 18px auto 30px auto;
            cursor: pointer;
            letter-spacing: 4px;
            transition: background 0.2s, color 0.2s;
            font-family: 'HarmonyOS Sans', 'Noto Sans SC', 'Noto Sans TC', 'Microsoft YaHei', '微软雅黑', 'Arial', sans-serif;
        }
        .main-btn:hover {
            background: #fff;
            color: #111;
            border: 1.5px solid #111;
        }
        .main-btn:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            border: none;
        }
        .centered {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .result-container {
            margin-top: 20px;
            padding: 20px;
            border: 1.5px solid #222;
            border-radius: 12px;
            background: #fff;
        }
        .interpretation-content {
            font-family: 'HarmonyOS Sans', 'Noto Sans SC', 'Noto Sans TC', 'Microsoft YaHei', '微软雅黑', 'Arial', sans-serif;
        }
        .ai-interpretation {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 1.1rem;
            color: #444;
            max-height: 500px;       /* ✅ 加这行 */
            overflow-y: auto;        /* ✅ 加这行 */
        }
        .card {
            margin-bottom: 20px;
            border: 1.5px solid #222;
            border-radius: 12px;
            background: #fff;
        }
        .card-header {
            background: #fff;
            border-bottom: 1.5px solid #222;
            padding: 15px 20px;
            font-weight: 500;
            font-size: 1.2rem;
        }
        .card-body {
            padding: 20px;
        }
        .question-highlight {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #222;
            font-size: 1.1rem;
            color: #444;
        }
        .language-selector {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 1000;
        }
        .lang-btn {
            position: fixed;
            right: 18px;
            top: 60px;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.7;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
            z-index: 1000;
        }
        .lang-btn:hover {
            background: rgba(0,0,0,0.05);
            opacity: 1;
        }
        .lang-btn svg {
            width: 32px;
            height: 32px;
            display: block;
        }
        .lang-select-pop {
            position: fixed;
            right: 18px;
            top: calc(60px + 42px);
            background: #fff;
            border: 1.5px solid #222;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            z-index: 1001;
            min-width: 120px;
            padding: 8px 0;
            display: none;
        }
        .lang-option {
            padding: 10px 18px;
            font-size: 1.1rem;
            color: #222;
            cursor: pointer;
            text-align: left;
            background: #fff;
            border: none;
            width: 100%;
            outline: none;
            transition: background 0.2s;
        }
        .lang-option:hover, .lang-option.selected {
            background: #222;
            color: #fff;
        }
        .qimen-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: #222;
            border: 1.5px solid #222;
            border-radius: 12px;
            overflow: hidden;
        }
        .qimen-grid .palace {
            background: #fff;
            padding: 15px;
            min-height: 120px;
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: center;
        }
        .back-btn {
            display: inline-block;
            margin: 20px auto 0 0;
            background: none;
            border: 1.2px solid #222;
            color: #222;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 8px 18px;
            border-radius: 16px;
            transition: background 0.2s, color 0.2s;
        }
        .back-btn:hover {
            background: #222;
            color: #fff;
        }
        .progress-disclaimer {
            margin-top: 16px;          /* 空一行的间距 */
            text-align: center;        /* 居中显示文字 */
            font-size: 0.95rem;
            color: #888;
            line-height: 1.6;
            font-style: italic;
            white-space: pre-line;     /* 支持换行符 \n */
        }
        .hint-text {
            font-size: 0.9rem;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }
        /* 进度条弹出框样式 */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .progress-overlay.show {
            opacity: 1;
        }
        .progress-container {
            background: #fff;
            border: 1.5px solid #222;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .progress-overlay.show .progress-container {
            transform: translateY(0);
        }
        .progress-title {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 500;
            margin-bottom: 25px;
            color: #222;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }
        .progress-fill {
            width: 0%;
            height: 100%;
            background: #222;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            position: relative;
            padding: 0 10px;
        }
        .progress-label {
            text-align: center;
            flex: 1;
            position: relative;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s;
            padding: 0 5px;
        }
        .progress-label.active {
            color: #222;
            font-weight: 500;
            transform: scale(1.05);
        }
        .progress-status {
            text-align: center;
            font-size: 1.1rem;
            color: #444;
            margin-top: 20px;
            min-height: 24px;
            font-weight: 500;
        }
        .time-hint {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="main-container">

                <!-- 奇门遁甲介绍：繁体 -->
        <section id="desc-zhTW"
                 style="padding:20px; margin-top:40px; background:#fff; border-radius:12px; border:1px solid #ddd; line-height:1.8; font-size:15px; color:#444;">
          <h2 style="margin-bottom:12px; font-size:20px;">什麼是奇門遁甲？</h2>
          <p>
            奇門遁甲是一套源自《易經》的古老時空觀測與象徵推演系統。歷史上，它被用來理解時間、方向、
            人事變化與環境的交互關係。它並不是神秘力量，而是一套協助您認識大環境與思考行動時機的文化智慧。
          </p>

          <h3 style="margin-top:20px; font-size:18px;">奇門遁甲的三盤九宮架構</h3>
          <p>
            奇門遁甲由「天盤、地盤、人盤」三盤構成，象徵不同層次的資訊。
            天盤代表外在環境與整體趨勢；地盤象徵基礎與背景；人盤則反映您的主觀視角與行動方式。
          </p>
          <p>
            同時，奇門遁甲包含「八門、九星、八神、九宮」等象徵系統，讓您透過象徵結構理解事件本質。
            這些元素相互組合，構成一座九宮盤，幫助您從多角度觀察問題。
          </p>

          <h3 style="margin-top:20px; font-size:18px;">傳統知識的現代文化意義</h3>
          <p>
            如今，奇門遁甲更多被視為一種文化與象徵分析框架，而非預測工具。
            它能協助您反思人生中的變化、理解環境與自己的互動、整理思緒、並找到前進的方向。
          </p>
          <p>
            QimenAsk 以教育與文化角度呈現奇門遁甲，透過演算法與 AI，讓您能以現代方式接觸這項傳統智慧，
            並以此作為自我觀察與思考的工具，而非尋求確切結論。
          </p>

          <h3 style="margin-top:20px; font-size:18px;">如何使用 QimenAsk？</h3>
          <p>
            您只需要輸入出生資料與想探索的問題，系統便會幫您建立一座奇門九宮盤。
            AI 會根據盤局象徵意義提供文字解讀，協助您從文化與象徵的角度整理問題並獲得啟發。
          </p>

          <p style="margin-top:20px; font-style:italic; color:#666;">
            QimenAsk 僅供文化理解與自我反思用途，不構成任何形式的預測、醫療、法律或投資建議。
          </p>
        </section>

        <!-- 奇门遁甲介绍：简体 -->
        <section id="desc-zhCN"
                 style="padding:20px; margin-top:40px; background:#fff; border-radius:12px; border:1px solid #ddd; line-height:1.8; font-size:15px; color:#444; display:none;">
          <h2 style="margin-bottom:12px; font-size:20px;">什么是奇门遁甲？</h2>
          <p>
            奇门遁甲是一套源自《易经》的传统时空分析与象征推演系统。它通过时间、方向、自然符号与人事变化的结合，
            帮助您理解环境趋势、把握时机，并观察自身与外界的关系。
          </p>

          <h3 style="margin-top:20px; font-size:18px;">奇门遁甲的三盘九宫结构</h3>
          <p>
            奇门遁甲由「天盘、地盘、人盘」组成，象征不同层面的信息来源。
            天盘象征外部环境；地盘代表基础背景；人盘则反映您自身的选择与行动。
          </p>
          <p>
            结合八门、九星、八神与九宫等象征符号，奇门遁甲提供了一个结构化的视角，
            让您能够从不同维度审视问题、理解事件。
          </p>

          <h3 style="margin-top:20px; font-size:18px;">现代文化中的意义</h3>
          <p>
            现代社会中，奇门遁甲常被视为一种文化框架，用于理解变化、分析情境与促进自我觉察。
            它并不提供确定的预测，而是一种帮助您反思与思考的工具。
          </p>
          <p>
            QimenAsk 通过算法与 AI，为您以现代方式呈现奇门遁甲，帮助您从象征意义中获得启发，
            并在面对问题时整理思绪。
          </p>

          <h3 style="margin-top:20px; font-size:18px;">如何使用 QimenAsk？</h3>
          <p>
            您只需输入出生信息与问题，系统即可生成一座奇门九宫盘。
            AI 会根据盘局提供文化化的象征解读，帮助您从多个角度理解问题背后的结构。
          </p>

          <p style="margin-top:20px; font-style:italic; color:#666;">
            QimenAsk 仅以文化研究与个人反思为目的，不构成任何形式的预测、医疗、法律或投资建议。
          </p>
        </section>

        <!-- 奇门遁甲介绍：英文 -->
        <section id="desc-en"
                 style="padding:20px; margin-top:40px; background:#fff; border-radius:12px; border:1px solid #ddd; line-height:1.8; font-size:15px; color:#444; display:none;">
          <h2 style="margin-bottom:12px; font-size:20px;">What Is Qimen Dunjia?</h2>
          <p>
            Qimen Dunjia is an ancient Chinese system of temporal–spatial analysis and symbolic interpretation.
            Rather than predicting the future, it offers a structured way for you to understand change, assess timing,
            and reflect on the relationship between yourself and your environment.
          </p>

          <h3 style="margin-top:20px; font-size:18px;">The Structure of the Three Plates and Nine Palaces</h3>
          <p>
            Qimen Dunjia consists of the Heaven Plate, Earth Plate and Human Plate, representing different layers of insight.
            The Heaven Plate reflects external forces, the Earth Plate shows foundational conditions,
            and the Human Plate highlights your choices, perspectives and actions.
          </p>
          <p>
            Together with the Eight Doors, Nine Stars, Eight Deities and the Nine Palaces,
            Qimen Dunjia forms a symbolic framework that allows you to explore situations from multiple angles.
          </p>

          <h3 style="margin-top:20px; font-size:18px;">Cultural Meaning in a Modern Context</h3>
          <p>
            Today, Qimen Dunjia is often viewed as a cultural and philosophical system.
            It serves as a tool for you to analyze circumstances, gain clarity, and understand how timing and environment
            interact with your personal decisions.
          </p>
          <p>
            QimenAsk presents this traditional knowledge in a modern, educational way.
            Through algorithmic calculation and AI-generated interpretation, you can explore the symbolic meaning of your chart
            and use it as inspiration for reflection and personal insight.
          </p>

          <h3 style="margin-top:20px; font-size:18px;">How to Use QimenAsk</h3>
          <p>
            You simply enter your birth information, question and charting time.
            The system will generate a Qimen chart for you, and AI will provide a cultural and symbolic interpretation
            to help you better understand the patterns and relationships behind your question.
          </p>

          <p style="margin-top:20px; font-style:italic; color:#666;">
            QimenAsk is intended for cultural learning and personal reflection only.
            It does not provide predictive, medical, legal or financial advice.
          </p>
        </section>
        
        <!-- 语言选择按钮和弹窗 -->
        <button class="lang-btn" id="langBtn" title="切換語言" aria-label="切換語言">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 0 20M12 2a15.3 15.3 0 0 0 0 20"/></svg>
        </button>
        <div class="lang-select-pop" id="langPop" role="menu" aria-label="語言選擇">
            <button class="lang-option selected" data-lang="zh-TW" role="menuitem">繁體中文</button>
            <button class="lang-option" data-lang="en" role="menuitem">English</button>
            <button class="lang-option" data-lang="zh-CN" role="menuitem">简体中文</button>
        </div>

        <!-- 页面一：输入信息 -->
        <div id="page-input">
            <div class="title" id="titleText" data-i18n="main_title">奇門解盤</div>
            <hr class="divider">
            <form id="infoForm" autocomplete="off">
                <input type="hidden" id="langInput" name="lang" value="zh-TW">
                <input type="hidden" id="method" name="method" value="chabu">
                <input type="hidden" id="type" name="type" value="shijia">
                
                <div class="form-group">
                    <label class="form-label" for="birth_date" data-i18n="birth_date">出生日期</label>
                    <input type="date" id="birth_date" name="birth_date" class="input-box" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="birth_time" data-i18n="birth_time">出生時辰</label>
                    <select id="birth_time" name="birth_time" class="form-select" required>
                        <option value="" data-i18n="please_select">請選擇</option>
                        <option value="子" data-i18n="hour_zi">子時（23:00 ~ 00:59）</option>
                        <option value="丑" data-i18n="hour_chou">丑時（01:00 ~ 02:59）</option>
                        <option value="寅" data-i18n="hour_yin">寅時（03:00 ~ 04:59）</option>
                        <option value="卯" data-i18n="hour_mao">卯時（05:00 ~ 06:59）</option>
                        <option value="辰" data-i18n="hour_chen">辰時（07:00 ~ 08:59）</option>
                        <option value="巳" data-i18n="hour_si">巳時（09:00 ~ 10:59）</option>
                        <option value="午" data-i18n="hour_wu">午時（11:00 ~ 12:59）</option>
                        <option value="未" data-i18n="hour_wei">未時（13:00 ~ 14:59）</option>
                        <option value="申" data-i18n="hour_shen">申時（15:00 ~ 16:59）</option>
                        <option value="酉" data-i18n="hour_you">酉時（17:00 ~ 18:59）</option>
                        <option value="戌" data-i18n="hour_xu">戌時（19:00 ~ 20:59）</option>
                        <option value="亥" data-i18n="hour_hai">亥時（21:00 ~ 22:59）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="gender" data-i18n="gender">性別</label>
                    <select id="gender" name="gender" class="form-select" required>
                        <option value="" data-i18n="please_select">請選擇</option>
                        <option value="male" data-i18n="gender_male">男</option>
                        <option value="female" data-i18n="gender_female">女</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="birth_city" data-i18n="birth_city">出生地點</label>
                    <input type="text" id="birth_city" name="birth_city" class="input-box" required data-i18n-placeholder="birth_city_placeholder">
                </div>

                <div class="form-group">
                    <label class="form-label" for="qimen_datetime" data-i18n="time_label">
                        排盤時間
                        <span class="hint-inline" data-i18n="time_method_hint">（預設使用時家拆補法）</span>
                    </label>
                    <input type="datetime-local" id="qimen_datetime" name="qimen_datetime" class="input-box" required>
                    <div class="hint-text" data-i18n="time_method_hint">預設使用時家拆補法</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="question" data-i18n="question_label">您的問題</label>
                    <textarea id="question" name="question" class="input-box" rows="3" required style="resize:vertical;" data-i18n-placeholder="question_placeholder"></textarea>
                </div>

                <button type="submit" class="main-btn" id="submitBtn" data-i18n="submit_button">解盤</button>
            </form>

            <!-- 进度条弹出框 -->
            <div class="progress-overlay" id="progressOverlay">
                <div class="progress-container">
                    <div class="progress-title" data-i18n="progress_title">奇門解盤進行中</div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>

                    <div class="progress-labels">
                        <div class="progress-label" id="label1" data-i18n="step_1">建立奇門局</div>
                        <div class="progress-label" id="label2" data-i18n="step_2">分析天地人盤</div>
                        <div class="progress-label" id="label3" data-i18n="step_3">提取八門八神</div>
                        <div class="progress-label" id="label4" data-i18n="step_4">洞察未來玄機</div>
                    </div>                    

                    <div class="progress-disclaimer" data-i18n="disclaimer_text">
                        ⚠️ 結果僅供娛樂，切勿過度解讀。<br>
                        解盤約需1分鐘，請耐心等待。
                    </div>
                </div>
            </div>
        </div>

        <!-- 页面二：解读展示 -->
        <div id="resultContainer" class="result-container" style="display:none;">
            <div class="centered">
                <div class="card mb-4">
                    <div class="card-header" data-i18n="card_interpretation">排盤解讀</div>
                    <div class="card-body">
                        <div id="questionDisplay" class="question-highlight" style="display: none;"></div>
                        <div id="aiInterpretation" class="ai-interpretation"></div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header" data-i18n="card_pan">排盤圖</div>
                    <div class="card-body">
                        <div class="qimen-grid">
                            <div class="palace" id="gong-巽"></div>
                            <div class="palace" id="gong-離"></div>
                            <div class="palace" id="gong-坤"></div>
                            <div class="palace" id="gong-震"></div>
                            <div class="palace" id="gong-中"></div>
                            <div class="palace" id="gong-兌"></div>
                            <div class="palace" id="gong-艮"></div>
                            <div class="palace" id="gong-坎"></div>
                            <div class="palace" id="gong-乾"></div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header" data-i18n="card_basic_info">排盤基本信息</div>
                    <div class="card-body" id="basicInfoContent">
                        <!-- 后续用 JS 插入内容 -->
                    </div>
                </div>

<!--                 <button class="back-btn" id="backBtn" data-i18n="back">返回</button> -->

                <!-- ✅ 再问一个问题按钮（自动跳转首页 + 自动填时间） -->
                <button class="back-btn" id="askAgainBtn" style="margin-left: 12px;" data-i18n="ask_again">
                    再問一個問題（自動換時辰）
                  </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const i18n = {
            'zh-TW': {
                'page_title': '奇門解盤',
                'main_title': '奇門解盤',
                'time_label': '排盤時間',
                'time_method_hint': '預設使用時家拆補法',
                'birth_date': '出生日期',
                'birth_time': '出生時辰',
                'gender': '性別',
                'gender_male': '男',
                'gender_female': '女',
                'birth_city': '出生地點',
                'birth_city_placeholder': '如：台北市',
                'question_label': '您的問題',
                'question_placeholder': '請輸入您想要諮詢的問題...如：我今年運勢如何？我和男友今年感情發展如何？',
                'please_select': '請選擇',
                'submit_button': '解盤',
                'card_interpretation': '排盤解讀',
                'card_pan': '排盤圖',
                'hour_zi': '子時（23:00 ~ 00:59）',
                'hour_chou': '丑時（01:00 ~ 02:59）',
                'hour_yin': '寅時（03:00 ~ 04:59）',
                'hour_mao': '卯時（05:00 ~ 06:59）',
                'hour_chen': '辰時（07:00 ~ 08:59）',
                'hour_si': '巳時（09:00 ~ 10:59）',
                'hour_wu': '午時（11:00 ~ 12:59）',
                'hour_wei': '未時（13:00 ~ 14:59）',
                'hour_shen': '申時（15:00 ~ 16:59）',
                'hour_you': '酉時（17:00 ~ 18:59）',
                'hour_xu': '戌時（19:00 ~ 20:59）',
                'hour_hai': '亥時（21:00 ~ 22:59）',
                'step_1': '建立奇門局',
                'step_2': '分析天地人盤',
                'step_3': '提取八門八神',
                'step_4': '洞察未來玄機',
                'status_1': '正在建立奇門局...',
                'status_2': '分析天盤、地盤與人盤...',
                'status_3': '提取八門八神...',
                'status_4': '洞察未來玄機...',
                'complete': '解盤完成！',
                'progress_title': '奇門解盤進行中',
                'ask_again': '再問一個問題（自動換時辰）', // 繁體
                'disclaimer_text': '⚠️ AI解讀奇門遁甲僅供娛樂參考,請勿過度解讀。\n解盤過程需約1分鐘，請耐心等待...',
                'footer_about_title': '關於 QimenAsk',
                'footer_about_p1': 'QimenAsk 是一個以中國傳統哲學為靈感的文化性網站，提供以學習與自我反思的方式探索《易經》與奇門遁甲等古老體系。',
                'footer_about_p2': '我們將奇門遁甲理解為一套關於時間、空間與自然元素互動的分析框架，協助使用者做出更審慎的思考與判斷。',
                'footer_privacy_title': '隱私政策',
                'footer_privacy_p1': '本網站使用 Google AdSense 展示廣告，可能使用 cookies 進行統計與個人化；我們不收集功能所需之外的個人資訊。來自歐盟/英國的使用者將看到符合法規的同意訊息。',
                'footer_contact_title': '聯絡方式',
                'footer_contact_email_label': '電子郵件：',
                'footer_disclaimer': '本網站內容僅用於文化與學習目的，不構成命理、醫療、法律與投資建議。'
            },
            'en': {
                'page_title': 'Qi Men Divination',
                'main_title': 'Qi Men Divination',
                'time_label': 'Divination Time',
                'time_method_hint': 'Default: Shi Jia Method (Split & Patch)',
                'birth_date': 'Birth Date',
                'birth_time': 'Birth Time',
                'gender': 'Gender',
                'gender_male': 'Male',
                'gender_female': 'Female',
                'birth_city': 'Birth Place',
                'birth_city_placeholder': 'e.g. Los Angeles',
                'question_label': 'Your Question',
                'question_placeholder': 'Enter your question here...i.e. How will my career be in 2025?',
                'please_select': 'Please select',
                'submit_button': 'Divine',
                'card_interpretation': 'Interpretation',
                'card_pan': 'Pan Chart',
                'hour_zi': 'Zi Hour (23:00 ~ 00:59)',
                'hour_chou': 'Chou Hour (01:00 ~ 02:59)',
                'hour_yin': 'Yin Hour (03:00 ~ 04:59)',
                'hour_mao': 'Mao Hour (05:00 ~ 06:59)',
                'hour_chen': 'Chen Hour (07:00 ~ 08:59)',
                'hour_si': 'Si Hour (09:00 ~ 10:59)',
                'hour_wu': 'Wu Hour (11:00 ~ 12:59)',
                'hour_wei': 'Wei Hour (13:00 ~ 14:59)',
                'hour_shen': 'Shen Hour (15:00 ~ 16:59)',
                'hour_you': 'You Hour (17:00 ~ 18:59)',
                'hour_xu': 'Xu Hour (19:00 ~ 20:59)',
                'hour_hai': 'Hai Hour (21:00 ~ 22:59)',
                'step_1': 'Establish Qi Men',
                'step_2': 'Analyze Charts',
                'step_3': 'Extract Elements',
                'step_4': 'Divine Future',
                'status_1': 'Establishing Qi Men chart...',
                'status_2': 'Analyzing Heaven, Earth & Human charts...',
                'status_3': 'Extracting Eight Gates & Deities...',
                'status_4': 'Divining future insights...',
                'complete': 'Divination Complete!',
                'progress_title': 'Qi Men Divination in Progress',
                'ask_again': 'Ask another question (auto next hour)', // English
                'disclaimer_text': '⚠️ AI-based Qi Men Dun Jia interpretation is for entertainment only.\nPlease do not take it too seriously. The process takes about 1 minute. Please wait patiently...',
                'footer_about_title': 'About QimenAsk',
                'footer_about_p1': 'QimenAsk is a cultural web project inspired by traditional Chinese philosophy, offering an educational and self-reflective way to explore the I Ching and Qimen Dunjia.',
                'footer_about_p2': 'We present Qimen Dunjia as a framework that studies interactions of time, space, and natural elements to support thoughtful understanding and decision-making.',
                'footer_privacy_title': 'Privacy Policy',
                'footer_privacy_p1': 'This site uses Google AdSense and may use cookies for analytics and personalization. We do not collect personally identifiable information beyond what is necessary for functionality. Users in the EU/UK will see a compliant consent message.',
                'footer_contact_title': 'Contact',
                'footer_contact_email_label': 'Email: ',
                'footer_disclaimer': 'For cultural and educational purposes only; not professional advice in fortune-telling, medical, legal, or financial domains.'
            },
            'zh-CN': {
                'page_title': '奇门解盘',
                'main_title': '奇门解盘',
                'time_label': '排盘时间',
                'time_method_hint': '默认使用时家拆补法',
                'birth_date': '出生日期',
                'birth_time': '出生时辰',
                'gender': '性别',
                'gender_male': '男',
                'gender_female': '女',
                'birth_city': '出生地点',
                'birth_city_placeholder': '如：北京市',
                'question_label': '您的问题',
                'question_placeholder': '请输入您想要咨询的问题...如：我今年财运如何？我和男友今年感情发展如何？',
                'please_select': '请选择',
                'submit_button': '解盘',
                'card_interpretation': '解盘结果',
                'card_pan': '排盘图',
                'hour_zi': '子时（23:00 ~ 00:59）',
                'hour_chou': '丑时（01:00 ~ 02:59）',
                'hour_yin': '寅时（03:00 ~ 04:59）',
                'hour_mao': '卯时（05:00 ~ 06:59）',
                'hour_chen': '辰时（07:00 ~ 08:59）',
                'hour_si': '巳时（09:00 ~ 10:59）',
                'hour_wu': '午时（11:00 ~ 12:59）',
                'hour_wei': '未时（13:00 ~ 14:59）',
                'hour_shen': '申时（15:00 ~ 16:59）',
                'hour_you': '酉时（17:00 ~ 18:59）',
                'hour_xu': '戌时（19:00 ~ 20:59）',
                'hour_hai': '亥时（21:00 ~ 22:59）',
                'step_1': '建立奇门局',
                'step_2': '分析天地人盘',
                'step_3': '提取八门八神',
                'step_4': '洞察未来玄机',
                'status_1': '正在建立奇门局...',
                'status_2': '分析天盘、地盘与人盘...',
                'status_3': '提取八门八神...',
                'status_4': '洞察未来玄机...',
                'complete': '解盘完成！',
                'progress_title': '奇门解盘进行中',
                'ask_again': '再问一个问题（自动换时辰）', // 简体
                'disclaimer_text': '⚠️ AI解盘仅供娱乐参考,请勿过度解读。\n解盘过程需约1分钟,请耐心等待...',
                'footer_about_title': '关于 QimenAsk',
                'footer_about_p1': 'QimenAsk 是一个以中国传统哲学为灵感的文化性网站，提供以学习与自我反思的方式探索《易经》和奇门遁甲等古老体系。',
                'footer_about_p2': '我们将奇门遁甲理解为一套研究时间、空间与自然元素互动的分析框架，帮助用户进行理性思考与判断。',
                'footer_privacy_title': '隐私政策',
                'footer_privacy_p1': '本网站使用 Google AdSense 展示广告，可能使用 cookies 进行统计与个性化；我们不收集功能所需之外的个人信息。来自欧盟/英国的用户将看到符合法规的同意提示。',
                'footer_contact_title': '联系方式',
                'footer_contact_email_label': '邮箱：',
                'footer_disclaimer': '本站内容仅用于文化与学习目的，不构成命理、医疗、法律与投资建议。'
                
            }
        };

        document.addEventListener('DOMContentLoaded', function() {

            // ✅ 正确生成本地 ISO 字符串（yyyy-MM-ddTHH:mm）
            function toLocalDatetimeInputString(date) {
                const pad = n => n < 10 ? '0' + n : n;
                return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
            }

            
            // 语言切换功能
            const langBtn = document.getElementById('langBtn');
            const langPop = document.getElementById('langPop');
            const langOptions = document.querySelectorAll('.lang-option');
            let currentLang = 'zh-TW';

            function updateLanguage(lang) {
                currentLang = lang;
                document.documentElement.lang = lang;
                document.getElementById('langInput').value = lang;
                document.getElementById('desc-zhTW').style.display = (lang === 'zh-TW') ? 'block' : 'none';
                document.getElementById('desc-zhCN').style.display = (lang === 'zh-CN') ? 'block' : 'none';
                document.getElementById('desc-en').style.display  = (lang === 'en')    ? 'block' : 'none';
                
                // 更新所有带有data-i18n属性的元素
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (i18n[lang][key]) {
                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            element.placeholder = i18n[lang][key];
                        } else {
                            element.textContent = i18n[lang][key];
                        }
                    }
                });

                // 更新所有带有data-i18n-placeholder属性的元素
                document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    if (i18n[lang][key]) {
                        element.placeholder = i18n[lang][key];
                    }
                });

                // 更新语言选项高亮
                langOptions.forEach(btn => {
                    btn.classList.toggle('selected', btn.getAttribute('data-lang') === lang);
                });

                // 更新提示文本
                const methodHint = document.getElementById('methodHint');
                const typeHint = document.getElementById('typeHint');
                if (methodHint) methodHint.textContent = i18n[lang]['hint_method'] || '';
                if (typeHint) typeHint.textContent = i18n[lang]['hint_type'] || '';
            }

            // 语言切换按钮点击事件
            langBtn.onclick = function(e) {
                langPop.style.display = langPop.style.display === 'block' ? 'none' : 'block';
                e.stopPropagation();
            };

            // 语言选项点击事件
            langOptions.forEach(btn => {
                btn.onclick = function() {
                    updateLanguage(this.getAttribute('data-lang'));
                    langPop.style.display = 'none';
                };
            });

            // 点击其他地方关闭语言选择弹窗
            document.body.onclick = function(e) {
                if (!langPop.contains(e.target) && e.target !== langBtn) {
                    langPop.style.display = 'none';
                }
            };

            // 表单提交处理
            const infoForm = document.getElementById('infoForm');
            const submitBtn = document.getElementById('submitBtn');
            const pageInput = document.getElementById('page-input');
            const resultContainer = document.getElementById('resultContainer');
            const backBtn = document.getElementById('backBtn');

            // 进度条相关变量
            const progressOverlay = document.getElementById('progressOverlay');
            const progressFill = document.getElementById('progressFill');
            const progressLabels = document.querySelectorAll('.progress-label');
            const progressStatus = document.getElementById('progressStatus');

            let current = 0;

            function animateProgress() {
                if (current < progressLabels.length) {
                    progressLabels.forEach((label, idx) => {
                        label.classList.toggle('active', idx === current);
                    });
                    progressFill.style.width = ((current + 1) / progressLabels.length * 100) + '%';
                    current++;
                    setTimeout(animateProgress, 13000); // 每步13秒
                } else {
                    progressLabels.forEach(label => label.classList.add('active'));
                    progressFill.style.width = '100%';
                }
            }

            function showProgress() {
                progressOverlay.style.display = 'flex';
                // 触发重排以启动动画
                progressOverlay.offsetHeight;
                progressOverlay.classList.add('show');
            }

            function hideProgress() {
                progressOverlay.classList.remove('show');
                setTimeout(() => {
                    progressOverlay.style.display = 'none';
                }, 300); // 等待动画完成
            }

          infoForm.onsubmit = async function(e) {
            e.preventDefault();
            if (!infoForm.checkValidity()) {
              infoForm.reportValidity();
              return;
            }
        
            submitBtn.disabled = true;
            submitBtn.textContent = currentLang === 'en' ? 'Processing...' : '处理中...';
        
            // 显示进度条弹窗并启动动画
            showProgress();
            current = 0; // 重置进度
            animateProgress();
        
            try {
              const formData = new FormData(infoForm);
        
              const response = await fetch('/calculate', {
                method: 'POST',
                body: formData,
              });
        
              if (!response.ok) {
                throw new Error(await response.text());
              }
        
              const result = await response.json();
        
              // —— 展示结果 —— //
              // 显示问题
              const questionDisplay = document.getElementById('questionDisplay');
              questionDisplay.textContent = formData.get('question');
              questionDisplay.style.display = 'block';
        
              // 显示解读
              document.getElementById('aiInterpretation').innerHTML =
                (result.interpretation || '暂无解读内容。').replace(/\n/g, '<br>');
        
              // 显示基本信息
              const basicInfo = result.basic_info;
              let basicInfoHtml = '';
              if (basicInfo && typeof basicInfo === 'object') {
                for (const key in basicInfo) {
                  const value = basicInfo[key];
                  if (value && typeof value === 'object') {
                    basicInfoHtml += `<strong>${key}：</strong><br>`;
                    for (const subKey in value) {
                      basicInfoHtml += `&nbsp;&nbsp;&nbsp;&nbsp;${subKey}：${value[subKey]}<br>`;
                    }
                  } else {
                    basicInfoHtml += `<strong>${key}：</strong>${value ?? '—'}<br>`;
                  }
                }
              } else {
                basicInfoHtml = currentLang === 'en'
                  ? '<em>No basic information available</em>'
                  : '<em>无可用基本信息</em>';
              }
              document.getElementById('basicInfoContent').innerHTML = basicInfoHtml;
        
              // 显示排盘图
              const palaceData = result.palace_data;
              if (palaceData) {
                for (const gong in palaceData) {
                  const el = document.getElementById(`gong-${gong}`);
                  const data = palaceData[gong];
                  if (el && data) {
                    el.innerHTML = ["神", "門", "星", "天盤", "地盤"]
                      .map(key => data[key] ? `${key}：${data[key]}` : '')
                      .filter(Boolean)
                      .join("<br>");
                  }
                }
              }
        
              // 切到结果页
              pageInput.style.display = 'none';
              resultContainer.style.display = 'block';
              document.getElementById('langBtn').style.display = 'none';
              resultContainer.scrollIntoView({ behavior: 'smooth' });
        
            } catch (error) {
              console.error('request failed:', error);
              alert((currentLang === 'en' ? 'Error: ' : '错误：') + (error?.message || error));
            } finally {
              hideProgress();
              submitBtn.disabled = false;
              submitBtn.textContent = i18n[currentLang]['submit_button'];
            }
          };

            // 返回按钮点击事件
            // backBtn.onclick = function() {
            //     document.getElementById('langBtn').style.display = 'block'; // ✅ 重新显示语言按钮
            //     resultContainer.style.display = 'none';
            //     pageInput.style.display = 'block';
            //     pageInput.scrollIntoView({ behavior: 'smooth' });
            
            //     // ✅ 隐藏进度条弹出框
            //     hideProgress();
            
            //     // ✅ 重置进度条状态
            //     progressFill.style.width = '0%';
            //     progressLabels.forEach(label => label.classList.remove('active'));
            //     progressStatus.textContent = '';
            
            //     // ✅ 清空结果显示内容（可选）
            //     document.getElementById('aiInterpretation').textContent = '';
            //     document.getElementById('basicInfoContent').innerHTML = '';
            //     document.getElementById('questionDisplay').style.display = 'none';
            // };

            // 设置默认时间
            const now = new Date();
            const pad = n => n < 10 ? '0' + n : n;
            const defaultTime = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
            document.getElementById('qimen_datetime').value = defaultTime;

            // 设置默认出生日期（当前日期）
            document.getElementById('birth_date').value = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;

            // 初始化语言
            // 根據用戶瀏覽器語言自動設置語言
            let userLang = navigator.language || navigator.userLanguage;
            if (userLang.startsWith('zh-CN')) {
                updateLanguage('zh-CN');
            } else if (userLang.startsWith('zh')) {
                updateLanguage('zh-TW');
            } else {
                updateLanguage('en');
            }

            // ✅ 解析 autoTime 参数并填入排盘时间字段
            const params = new URLSearchParams(window.location.search);
            const autoTimeParam = params.get('autoTime');
            const qimenInput = document.getElementById('qimen_datetime');

            if (autoTimeParam && qimenInput) {
                const autoDate = new Date(autoTimeParam);
                qimenInput.value = toLocalDatetimeInputString(autoDate);

                const hint = document.createElement('div');
                hint.className = 'time-hint';
                let timeLabel;
                if (currentLang === 'en') {
                    timeLabel = `Auto-selected next hour: ${autoDate.toLocaleString('en-US', { hour12: false })}`;
                } else if (currentLang === 'zh-CN') {
                    timeLabel = `已为你自动选用下一个时辰：${autoDate.toLocaleString('zh-CN', { hour12: false })}`;
                } else {
                    timeLabel = `已為你自動選用下一个時辰：${autoDate.toLocaleString('zh-TW', { hour12: false })}`;
                }
                hint.textContent = timeLabel;
                qimenInput.parentNode.appendChild(hint);
            }

        // ✅ 再问一个问题按钮功能（基于当前 input 值 +2 小时）
        const askAgainBtn = document.getElementById('askAgainBtn');
        if (askAgainBtn) {
        askAgainBtn.addEventListener('click', () => {
            const qimenInput = document.getElementById('qimen_datetime');

            // 解析 input（本地时间，不带时区）
            const [d, t] = (qimenInput?.value || '').split('T');
            if (!d || !t) {
            // 如果意外为空，就退回用当前时间作为基准
            const now = new Date();
            now.setMinutes(0, 0, 0);
            now.setHours(now.getHours() + 2);
            const localStr = toLocalDatetimeInputString(now);
            window.location.href = window.location.pathname + '?autoTime=' + encodeURIComponent(localStr);
            return;
            }
            const [yy, mm, dd] = d.split('-').map(Number);
            const [HH, MM]     = t.split(':').map(Number);
            const base = new Date(yy, mm - 1, dd, HH, MM, 0, 0);

            // +2 小时，并对齐到整时（可选）
            base.setMinutes(0, 0, 0);
            base.setHours(base.getHours() + 2);

            // 用本地无时区字符串传参，避免 UTC 偏移
            const localStr = toLocalDatetimeInputString(base);
            window.location.href = window.location.pathname + '?autoTime=' + encodeURIComponent(localStr);
        });
        }
        });
    </script>
      <!-- ✅ Footer（多语言，随浏览器和右上角语言选项联动） -->
  <footer style="background:#f8f8f8; padding:20px; margin-top:40px; font-size:14px; color:#555;">
    <h3 data-i18n="footer_about_title"></h3>
    <p data-i18n="footer_about_p1"></p>
    <p data-i18n="footer_about_p2"></p>

    <h3 data-i18n="footer_privacy_title"></h3>
    <p data-i18n="footer_privacy_p1"></p>

    <h3 data-i18n="footer_contact_title"></h3>
    <p>
      <span data-i18n="footer_contact_email_label"></span>
      <a href="mailto:contact@qimenask.com">contact@qimenask.com</a>
    </p>

    <p style="font-size:12px;color:#999;margin-top:10px;">
      <span>© <span id="yearNow"></span> QimenAsk.com · </span>
      <span data-i18n="footer_disclaimer"></span>
    </p>
  </footer>
</body>
</html> 
